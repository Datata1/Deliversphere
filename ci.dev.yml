schemaVersion: v0.2
prepare:
  steps:
    - name: install nix dependencies
      command: nix-env -iA nixpkgs.rustup nixpkgs.protobuf
    - name: configure Rust
      command: rustup default stable
    - name: build rust agent
      command: cd apps/agent && cargo build
    - name: build rust server
      command: cd apps/server && cargo build
    - name: install node dependencies
      command: '[ "$(node -v)" = "v22.15.0" ] || sudo n 22.15.0; cd apps/frontend &&
        yarn install'
    - name: install sqlx-cli
      command: cargo install sqlx-cli
test:
  steps: []
run:
  frontend:
    steps:
      - name: Deploy
        command: '[ "$(node -v)" = "v22.15.0" ] || sudo n 22.15.0 && cd
          packages/frontend && yarn dev'
    plan: 8
    replicas: 1
    network:
      ports:
        - port: 3000
          isPublic: true
      paths:
        - port: 3000
          path: /
  server:
    steps:
      - name: Deploy
        command: cd packages/server && cargo run
    plan: 8
    replicas: 1
    network:
      ports:
        - port: 3000
          isPublic: true
        - port: 3001
          isPublic: false
      paths:
        - port: 3000
          path: /server
          stripPath: true
  agent:
    steps:
      - name: Deploy agent
        command: cd packages/agent && cargo run
    plan: 8
    replicas: 3
    network:
      ports:
        - port: 3000
          isPublic: false
      paths:
        - port: 3000
          path: /agent
          stripPath: true
